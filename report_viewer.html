<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Viewer</title>
  <style>
    :root {
      --primary-color: #bddafd;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    header {
      background-color: #2c3e50;
      color: white;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 15px;
    }
    
    .controls {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    select {
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background-color: white;
      cursor: pointer;
      min-width: 300px;
    }
    
    select:focus {
      outline: 2px solid #3498db;
    }
    
    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #3498db;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* Search Input */
    .search-input {
      padding: 8px 12px;
      font-size: 14px;
      border: 2px solid #bdc3c7;
      border-radius: 4px;
      background-color: white;
      min-width: 200px;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #3498db;
    }

    .search-input::placeholder {
      color: #95a5a6;
    }

    .viewer-container {
      flex: 1;
      padding: 20px;
      background-color: #ecf0f1;
      overflow: hidden;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: 2px solid #bdc3c7;
      border-radius: 4px;
      background-color: white;
    }
    
    .no-selection {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #7f8c8d;
      font-size: 18px;
    }
    
    footer {
      background-color: #34495e;
      color: #bdc3c7;
      padding: 15px 20px;
      text-align: center;
      font-size: 12px;
    }

    footer strong {
      color: var(--primary-color);
      font-weight: 600;
    }
  </style>
</head>

<body>
  <header>
    <h1>Report Viewer</h1>
    <div class="controls">
      <div class="control-group">
        <label for="reportSelector">Select Report:</label>
        <select id="reportSelector">
          <option value="">-- Select a report --</option>
        </select>
      </div>

      <div class="control-group">
        <label for="evaluationToggle">Show Evaluation:</label>
        <label class="toggle-switch">
          <input type="checkbox" id="evaluationToggle">
          <span class="slider"></span>
        </label>
      </div>

      <div class="control-group">
        <label for="searchFilter">Search:</label>
        <input 
          type="text" 
          id="searchFilter" 
          class="search-input" 
          placeholder="Enter keywords to filter..."
        >
      </div>
    </div>
  </header>
  
  <div class="viewer-container">
    <div id="noSelection" class="no-selection">
      Select a report to display it here
    </div>
    <iframe id="documentFrame" style="display: none;"></iframe>
  </div>
  
  <footer>
    <p>Powered by <strong>Ihg</strong> | Â© 2025 All Rights Reserved</p>
  </footer>
  
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const reportCategory = urlParams.get('category');
    const reportName = urlParams.get('name');
    
    const reportSelector = document.getElementById('reportSelector');
    const evaluationToggle = document.getElementById('evaluationToggle');
    const searchFilter = document.getElementById('searchFilter');
    const documentFrame = document.getElementById('documentFrame');
    const noSelection = document.getElementById('noSelection');
    
    // Configuration
    const config = {
      filePattern: /^(.+)_(\d{4})(\d{2})(\d{2})_(\d+)days\.html$/, // pattern: *_YYYYMMDD_Ddays.html
      sortOrder: 'desc' // 'asc' or 'desc'
    };
    
    // Extract date from filename
    function extractInfoFromName(filename) {
      const match = filename.match(config.filePattern);
      if (!match) return { filename, docType: null, startDate: null, endDate: null };
      
      const [, docType, year, month, day, durationInDays] = match;
      const startDate = new Date(year, month - 1, day);
      const endDate = new Date(startDate.getTime() + (durationInDays - 1) * 86400000);
      return { filename, docType, startDate, endDate };
    }
    
    // Format date for display
    function formatDate(fileObj) {
      if (fileObj.startDate && fileObj.endDate)
        return `${fileObj.startDate.toDateString()} ~ ${fileObj.endDate.toDateString()}`;
      return 'Unknown Date';
    }

    function toCamelCase(str) {
      return str
        .replace(/[\s_]+/g, ' ') // replace underscores/spaces with single space
        .trim()
        .replace(/[^a-zA-Z]+([a-z])/g, (match, chr) => chr.toUpperCase())
        .replace(/([a-z]{2})([A-Z])/g, (match, p1, p2) => p1 + ' ' + p2)
        .replace(/([A-Z]{2})([a-z])([a-z])/g, (match, p1, p2, p3) => p1 + ' ' + p2.toUpperCase() + p3)
        .replace(/^./, str[0].toUpperCase());
    }

    function formatFilename(filename) {
      const fileObj = extractInfoFromName(filename);
      if (fileObj.docType && fileObj.startDate && fileObj.endDate) {
        return `${toCamelCase(fileObj.docType)} (${formatDate(fileObj)})`;
      }
      // Fallback: just return filename
      return toCamelCase(filename.replace(/\.html$/i, ''));
    }

    // Process and sort files
    function processFileList(fileList) {
      // Filter files matching the pattern and extract dates
      const processedFiles = fileList
        .map(extractInfoFromName)
        .filter(item => item !== null);
      
      // Sort by startDate, then by docType
      processedFiles.sort((a, b) => {
        const order = config.sortOrder === 'desc' ? -1 : 1;
        
        // startDate comparison (null last)
        const aDateNull = a.startDate === null;
        const bDateNull = b.startDate === null;
        if (aDateNull !== bDateNull) return aDateNull ? 1 : -1;
        if (!aDateNull) {
          const dateComp = order * (a.startDate - b.startDate);
          if (dateComp !== 0) return dateComp;
        }
        
        // docType comparison (null last)
        const aTypeNull = a.docType === null;
        const bTypeNull = b.docType === null;
        if (aTypeNull !== bTypeNull) return aTypeNull ? 1 : -1;
        if (!aTypeNull) return a.docType.localeCompare(b.docType);
        
        return 0;
      });

      return processedFiles;
    }

    // Load files from JSON
    async function loadFiles() {
      try {
        const response = await fetch('files.json');
        const data = await response.json();
        populateDropdown(data, reportCategory);
      } catch (error) {
        console.error('Error loading files:', error);
        const option = document.createElement('option');
        option.textContent = 'Failed to load file list';
        option.disabled = true;
        reportSelector.appendChild(option);
      }
    }
    
    // Populate dropdown with files
    function populateDropdown(data, targetCategory) {
      // Clear existing options
      reportSelector.replaceChildren();

      let selected = false;
      // Add options for each category
      for (const [category, {title, folderPath, files}] of Object.entries(data)) {
        if (targetCategory && targetCategory !== category) continue;
        
        // Sort files
        const processedFiles = processFileList(files);

        if (processedFiles.length === 0) continue;
        
        // Create optgroup
        const optgroup = document.createElement('optgroup');
        optgroup.label = title;
        
        // Add files
        processedFiles.forEach(fileObj => {
          const option = document.createElement('option');
          option.value = `${folderPath}\\${fileObj.filename}`;
          option.textContent = formatFilename(fileObj.filename); // TODO: More descriptive names can be added here
          if (category === targetCategory && fileObj.filename === reportName) {
            option.selected = true;
            selected = true;
          }
          optgroup.appendChild(option);
        });
        
        reportSelector.appendChild(optgroup);
      }

      // Add default option if none selected
      if (!selected) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '-- Select a report --';
        option.selected = true;
        option.disabled = true;
        option.hidden = true;
        reportSelector.prepend(option);
      } else {
        // Trigger change event to load selected report
        const event = new Event('change');
        reportSelector.dispatchEvent(event);
      }
    }

    function loadReport() {
      const selectedReport = reportSelector.value;
      if (!selectedReport) return;
      const showEval = evaluationToggle.checked ? 'showEval=true' : '';
      const keyword = searchFilter.value.trim();
      const search = keyword ? `search=${encodeURIComponent(keyword)}` : '';
      const timestamp = `_t=${new Date().getTime()}`;
      const params = [showEval, search, timestamp].filter(param => param).join('&');
      const url = params ? `${selectedReport}?${params}` : selectedReport;

      documentFrame.contentWindow.location.replace(url);
    }

    // Handle report selection
    reportSelector.addEventListener('change', (e) => {
      const selectedReport = e.target.value;
      
      if (selectedReport) {
        // Show iframe, hide message
        documentFrame.style.display = 'block';
        noSelection.style.display = 'none';
        loadReport();
      } else {
        // Show message, hide iframe
        documentFrame.style.display = 'none';
        noSelection.style.display = 'flex';

        // Reset frame without adding to history stack
        documentFrame.contentWindow.location.replace('about:blank');
      }
    });

    // Handle evaluation toggle
    evaluationToggle.addEventListener('change', (e) => {
      try {
        documentFrame.contentWindow.showEvaluation(e.target.checked);
      } catch (err) {
        console.error("Access denied or function not found:", err);
      }
    });

    // Handle search filter
    searchFilter.addEventListener('input', (e) => {
      try {
        documentFrame.contentWindow.applySearchFilter(e.target.value.trim());
      } catch (err) {
        console.error("Access denied or function not found:", err);
      }
    });

    // Initialize
    window.addEventListener('DOMContentLoaded', loadFiles);
  </script>
</body>
</html>